<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Estuda.ai</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css"> <style>
        /* Estilos da página de login (iguais aos anteriores) */
        body.login-page { display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f1f0ea; padding-top: 0; }
        .login-container { background-color: #fff; padding: 40px 50px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); text-align: center; max-width: 400px; width: 90%; }
        .login-container h1 { color: #474c5f; margin-bottom: 15px; font-size: 1.8em; font-weight: 600; }
        .login-container p { color: #666; margin-bottom: 30px; font-size: 1em; }
        .google-login-button { display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 25px; border: 1px solid #ccc; background-color: #fff; color: #444; border-radius: 6px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color 0.3s ease, box-shadow 0.2s ease; font-family: 'Montserrat', sans-serif; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .google-login-button:hover { background-color: #f8f8f8; box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        .google-login-button i { color: #DB4437; font-size: 1.2em; }
        #login-status { margin-top: 20px; font-size: 0.9em; color: #e53935; min-height: 1.2em; }
        /* Estilos para Log na Página (iguais aos anteriores) */
        #log-output-container { margin-top: 30px; border-top: 1px solid #eee; padding-top: 15px; }
        #log-output { background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 10px; font-family: monospace; font-size: 0.8em; height: 150px; overflow-y: auto; text-align: left; white-space: pre-wrap; word-wrap: break-word; color: #333; }
        #log-output .log-error { color: #e53935; font-weight: bold; }
    </style>
</head>
<body class="login-page">

    <div class="login-container">
        <h1>Bem-vindo!</h1>
        <p>Acesse sua conta para continuar.</p>
        <button id="google-login-btn" class="google-login-button">
            <i class="fab fa-google"></i> Entrar com Google
        </button>
        <div id="login-status"></div>

        <div id="log-output-container">
            <small>Logs de Depuração:</small>
            <pre id="log-output"></pre>
        </div>
    </div>

    <script type="module">
      // 1. Importa as funções necessárias dos SDKs via CDN
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
      // Removido Analytics se não for usar, mas pode manter se quiser
      // import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";

      // *** IMPORTANTE: Adiciona imports para Autenticação ***
      import {
          getAuth,
          GoogleAuthProvider,
          signInWithPopup,
          onAuthStateChanged
          // signOut // Importe se precisar de logout nesta página
      } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

      // (Se for usar Firestore nesta página, importe aqui também)
      // import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";


      // 2. Sua configuração Firebase (use a sua real aqui)
      const firebaseConfig = {
        apiKey: "AIzaSyDRRBT5cVklz8CIxD_VpsexaiErH09H8Hc",
        authDomain: "estudaai-ddb6a.firebaseapp.com",
        projectId: "estudaai-ddb6a",
        storageBucket: "estudaai-ddb6a.appspot.com",
        messagingSenderId: "974312409515",
        appId: "1:974312409515:web:ef635d71abf934241d6aee",
        measurementId: "G-9X8PNR6S6L" // Opcional
      };

      // --- Elementos do DOM e Variáveis Globais do Módulo ---
      const logOutput = document.getElementById('log-output');
      const loginButton = document.getElementById('google-login-btn');
      const loginStatus = document.getElementById('login-status');
      let app;
      let auth;
      let googleProvider;

      // --- Função de Log na Página (dentro do módulo) ---
      function logNaPagina(mensagem, tipo = 'info') {
        if (logOutput) {
            const agora = new Date().toLocaleTimeString('pt-BR');
            let textoMensagem = typeof mensagem === 'object' ? JSON.stringify(mensagem) : mensagem;
            const novaLinha = document.createElement('div');
            novaLinha.textContent = `[${agora}] ${textoMensagem}`;
            if (tipo === 'error') novaLinha.classList.add('log-error');
            logOutput.appendChild(novaLinha);
            logOutput.scrollTop = logOutput.scrollHeight;
        } else { if (tipo === 'error') console.error(mensagem); else console.log(mensagem); }
      }

      // --- Inicialização e Lógica Principal (dentro do módulo) ---
      try {
          // 3. Inicializa o Firebase App
          app = initializeApp(firebaseConfig);
          logNaPagina("Firebase App inicializado.");

          // 4. Inicializa os serviços necessários (Auth)
          auth = getAuth(app); // Passa a instância 'app'
          googleProvider = new GoogleAuthProvider();
          logNaPagina("Firebase Auth e Google Provider inicializados.");

          // const analytics = getAnalytics(app); // Se for usar Analytics
          // const db = getFirestore(app); // Se for usar Firestore nesta página

      } catch (e) {
          logNaPagina("ERRO na inicialização do Firebase: " + (e.message || e), 'error');
          if(loginButton) loginButton.disabled = true;
          if(loginStatus) loginStatus.textContent = "Erro crítico na inicialização.";
      }


      // --- Lógica de Login (Adaptada para API Modular) ---
      if (loginButton && auth && googleProvider) {
          logNaPagina(`Botão de login encontrado: Sim`);
          loginButton.addEventListener('click', () => {
              logNaPagina("Botão de login CLICADO!");
              loginStatus.textContent = 'Abrindo popup do Google...';
              logNaPagina('Tentando signInWithPopup...');

              // Chama signInWithPopup passando 'auth'
              signInWithPopup(auth, googleProvider)
                  .then((result) => {
                      logNaPagina("signInWithPopup SUCESSO!");
                      // Na API modular, não precisa mais de credentialFromResult para ter o user
                      const user = result.user;
                      logNaPagina(`Usuário: ${user.displayName} (${user.email})`);
                      loginStatus.textContent = 'Login realizado! Redirecionando...';
                      loginStatus.style.color = '#4caf50';
                      window.location.href = '/'; // Ajuste se necessário
                  }).catch((error) => {
                      logNaPagina("signInWithPopup ERRO!", 'error');
                      logNaPagina(`Código: ${error.code}`, 'error');
                      logNaPagina(`Mensagem: ${error.message}`, 'error');
                      // Tratamento de erros específico (igual ao anterior)
                      let mensagemErro = 'Ocorreu um erro durante o login.';
                      if (error.code === 'auth/popup-closed-by-user') mensagemErro = 'Janela de login fechada. Tente novamente.';
                      else if (error.code === 'auth/cancelled-popup-request') mensagemErro = 'Múltiplas tentativas de login.';
                      else if (error.code === 'auth/popup-blocked') mensagemErro = 'Popup bloqueado pelo navegador. Habilite popups.';
                      loginStatus.textContent = mensagemErro;
                      loginStatus.style.color = '#e53935';
                  });
          });
          logNaPagina("Listener adicionado ao botão de login.");
      } else if (!loginButton) {
           logNaPagina("ERRO: Botão com id 'google-login-btn' NÃO encontrado!", 'error');
      } else {
           logNaPagina("ERRO: Firebase Auth ou Provider não inicializado!", 'error');
           if(loginButton) loginButton.disabled = true;
           if(loginStatus) loginStatus.textContent = "Erro crítico na configuração.";
      }

      // --- Verifica se já está logado (Adaptado para API Modular) ---
      if (auth) {
           // Chama onAuthStateChanged passando 'auth'
           onAuthStateChanged(auth, (user) => {
               if (user) {
                   logNaPagina("Verificação: Usuário JÁ está logado.");
                   const pathAtual = window.location.pathname;
                   const ePaginaPrincipal = pathAtual === '/' || pathAtual.endsWith('/index.html'); // Ajuste
                   if (!ePaginaPrincipal) {
                        logNaPagina("Redirecionando para a página principal...");
                        window.location.href = '/';
                   } else { logNaPagina("Já está na página principal."); }
               } else {
                   logNaPagina("Verificação: Nenhum usuário logado.");
               }
           });
      } else {
          logNaPagina("ERRO: Auth não disponível para verificar estado de login.", 'error');
      }

    </script>
    </body>
</html>
